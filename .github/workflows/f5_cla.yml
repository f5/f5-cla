---
# F5 Contributor License Agreement (CLA) Workflow
#
# This reusable workflow enforces CLA signing for contributors to F5 OSS projects.
# It is designed to be copied into any F5 OSS repository and requires the F5_CLA_TOKEN
# secret to be configured in the repository settings.
#
# How it works:
#   1. On PR events (opened, closed, synchronize) or CLA-related comments, the workflow
#      checks whether all contributors have signed the F5 CLA.
#   2. If a contributor has not signed, the action posts a comment prompting them to read
#      and agree to the CLA by replying with the sign-off phrase.
#   3. Signatures are stored centrally in the f5/f5-cla-data repository.
#
# NGINX bypass:
#   For the nginx/nginx repository specifically, an additional bypass step runs before the
#   CLA check. Members of the nginx/nginx-backport team can skip the CLA if their PR
#   description includes "Contribution guidelines have been verified" and has not been edited
#   after creation. The NGINX org uses IdP-managed membership (SAML/SSO via F5), so team
#   membership inherently confirms the user is an F5 employee. All conditions must be met
#   simultaneously; if any check fails or errors, the CLA check runs as normal (fail-safe).
#
# Required secrets:
#   - F5_CLA_TOKEN: A personal access token (PAT) with the following scopes:
#       - repo            (to read/write CLA signature data in f5/f5-cla-data)
#       - read:org        (to verify team membership in the nginx org)
#
name: F5 CLA
on:
  # Triggered when a comment is posted on an issue or PR. The step-level if conditions
  # filter to only CLA-relevant comments ("recheck" or the CLA sign-off phrase).
  issue_comment:
    types: [created]
  # Triggered on PR lifecycle events. Uses pull_request_target (not pull_request) so the
  # workflow runs in the context of the base branch with access to repository secrets,
  # which is required for the CLA action to read/write signature data.
  pull_request_target:
    types: [opened, closed, synchronize]
# Top-level read-all ensures the workflow has baseline read access. Job-level permissions
# below grant the additional write scopes needed by the CLA action.
permissions: read-all
jobs:
  f5-cla:
    name: F5 CLA
    runs-on: ubuntu-24.04
    permissions:
      actions: write
      pull-requests: write
      statuses: write
    steps:
      # NGINX CLA bypass â€” see the script block below for full documentation.
      # The if condition pre-filters using cheap native checks (repo name,
      # event type, body text) to avoid running the script on repos/events
      # where it doesn't apply. Only runs on pull_request_target because
      # the bypass evaluates PR-level properties set at creation time.
      - name: Check NGINX contributor bypass conditions
        id: nginx-bypass
        if: >-
          github.repository == 'nginx/nginx' &&
          github.event_name == 'pull_request_target' &&
          contains(github.event.pull_request.body, 'Contribution guidelines have been verified')
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          # Uses F5_CLA_TOKEN (not GITHUB_TOKEN) because the team membership
          # check requires read:org scope.
          github-token: ${{ secrets.F5_CLA_TOKEN }}
          script: |
            // ================================================================
            // NGINX CLA Bypass â€” Verification Script
            //
            // Purpose:
            //   Determines whether the CLA check can be skipped for trusted
            //   NGINX contributors. Sets the "skip-cla" output to "true" ONLY
            //   when every condition below is satisfied.
            //
            // Conditions verified by this script:
            //   1. PR opener is a member of the nginx/nginx-backport team
            //      (also implies NGINX org membership and F5 employment,
            //      since the nginx org uses IdP-managed membership via
            //      F5 SAML/SSO)
            //   2. PR description has not been edited since creation
            //
            // Both conditions are checked in a single GraphQL query.
            //
            // Conditions already verified by the step's `if:` expression:
            //   - Repository is nginx/nginx
            //   - Event is pull_request_target (not issue_comment)
            //   - PR body contains "Contribution guidelines have been verified"
            //
            // Fail-safe design:
            //   The output defaults to "false" (line 1 below). Every code path
            //   that doesn't explicitly set it to "true" results in the CLA
            //   running normally. This includes API errors, missing permissions,
            //   network failures, and any unmet condition.
            //
            // API calls made:
            //   Single GraphQL query combining:
            //     - organization.team.members (team membership)
            //     - repository.pullRequest.userContentEdits (edit history)
            // ================================================================

            core.setOutput('skip-cla', 'false');

            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const prAuthor = pr.user.login;

            // ---------------------------------------------------------------
            // Single GraphQL query to verify both conditions
            //
            // 1. Team membership:
            //    organization.team.members(query:) filters team members by
            //    username. The query parameter is a fuzzy/substring match,
            //    so we must verify the returned login matches exactly.
            //    Team membership implies org membership and F5 employment
            //    (nginx org uses IdP-managed membership via F5 SAML/SSO),
            //    so a separate org or email check is unnecessary.
            //
            // 2. Edit history:
            //    userContentEdits tracks all edits to the PR's title and body.
            //    A totalCount of 0 means the content is unchanged since creation.
            //    We treat any edit (including title-only changes) as grounds to
            //    deny the bypass â€” this is intentionally conservative.
            //
            //    Possible states:
            //      - null/undefined: edit history unavailable â†’ deny bypass
            //      - totalCount > 0: content was edited      â†’ deny bypass
            //      - totalCount === 0: never edited           â†’ allow bypass
            //
            //    Returns null if edit history tracking is disabled on the repo,
            //    which we also treat as "bypass denied".
            //
            // Requires: read:org scope on the token.
            // ---------------------------------------------------------------
            let result;
            try {
              result = await github.graphql(`
                query($owner: String!, $name: String!, $number: Int!, $username: String!) {
                  organization(login: "nginx") {
                    team(slug: "nginx-backport") {
                      members(query: $username, first: 1) {
                        nodes { login }
                      }
                    }
                  }
                  repository(owner: $owner, name: $name) {
                    pullRequest(number: $number) {
                      userContentEdits(first: 1) {
                        totalCount
                      }
                    }
                  }
                }
              `, { owner, name: repo, number: pr.number, username: prAuthor });
            } catch (error) {
              core.info(`GraphQL query failed: ${error.message}. CLA check required.`);
              return;
            }

            // Verify team membership (exact match â€” query parameter is fuzzy).
            const members = result.organization?.team?.members?.nodes || [];
            const isMember = members.some(m => m.login === prAuthor);
            if (!isMember) {
              core.info(`"${prAuthor}" is not a member of the nginx/nginx-backport team. CLA check required.`);
              return;
            }
            core.info(`"${prAuthor}" is a member of the nginx/nginx-backport team.`);

            // Verify PR description has not been edited.
            const edits = result.repository?.pullRequest?.userContentEdits;
            if (!edits || edits.totalCount > 0) {
              core.info('PR description has been edited after creation or edit history is unavailable. CLA check required.');
              return;
            }

            // ---------------------------------------------------------------
            // All conditions passed â€” grant the bypass
            // ---------------------------------------------------------------
            core.info('All NGINX contributor bypass conditions met. Skipping CLA check.');
            core.setOutput('skip-cla', 'true');

            // Post a PR comment using GITHUB_TOKEN so it appears as the
            // github-actions bot rather than the F5_CLA_TOKEN PAT owner.
            const { getOctokit } = require('@actions/github');
            const ghClient = getOctokit(process.env.GITHUB_TOKEN);
            await ghClient.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body: 'All NGINX contributor bypass conditions met. Skipping CLA check.',
            });
        env:
          # GITHUB_TOKEN is used separately to post the bypass PR comment as
          # the github-actions bot (instead of the F5_CLA_TOKEN PAT owner).
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Run the CLA action. always() ensures this runs even if the bypass step
      # errors, preventing a broken bypass from silently disabling the CLA.
      - name: Run F5 Contributor License Agreement (CLA) assistant
        if: >-
          always() &&
          steps.nginx-bypass.outputs.skip-cla != 'true' &&
          ((github.event.comment.body == 'recheck' || github.event.comment.body == 'I have hereby read the F5 CLA and agree to its terms') || github.event_name == 'pull_request_target')
        uses: contributor-assistant/github-action@ca4a40a7d1004f18d9960b404b97e5f30a505a08 # v2.6.1
        with:
          # Path to the CLA document.
          path-to-document: https://github.com/f5/f5-cla/blob/main/docs/f5_cla.md
          # Custom CLA messages.
          custom-notsigned-prcomment: 'ðŸŽ‰ Thank you for your contribution! It appears you have not yet signed the [F5 Contributor License Agreement (CLA)](https://github.com/f5/f5-cla/blob/main/docs/f5_cla.md), which is required for your changes to be incorporated into an F5 Open Source Software (OSS) project. Please kindly read the [F5 CLA](https://github.com/f5/f5-cla/blob/main/docs/f5_cla.md) and reply on a new comment with the following text to agree:'
          custom-pr-sign-comment: 'I have hereby read the F5 CLA and agree to its terms'
          custom-allsigned-prcomment: 'âœ… All required contributors have signed the F5 CLA for this PR. Thank you!'
          # Remote repository storing CLA signatures.
          remote-organization-name: f5
          remote-repository-name: f5-cla-data
          # Branch where CLA signatures are stored.
          branch: main
          path-to-signatures: signatures/signatures.json
          # Comma separated list of usernames for maintainers or any other individuals who should not be prompted for a CLA.
          # NOTE: You will want to edit the usernames to suit your project needs.
          allowlist: Copilot,dependabot[bot],renovate[bot],nginx-bot
          # Do not lock PRs after a merge.
          lock-pullrequest-aftermerge: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERSONAL_ACCESS_TOKEN: ${{ secrets.F5_CLA_TOKEN }}
